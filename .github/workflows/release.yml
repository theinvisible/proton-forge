name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.3

  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required for creating releases
  packages: write  # Optional, for package publishing

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:25.10  # Build on latest Ubuntu release (Oracular Oriole)

    steps:
      - name: Install Git (required for checkout)
        run: |
          apt-get update
          apt-get install -y git

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt6 and dependencies
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y \
            cmake \
            build-essential \
            qt6-base-dev \
            qt6-base-dev-tools \
            libqt6core6 \
            libqt6widgets6 \
            libqt6network6 \
            libqt6concurrent6 \
            file \
            dpkg-dev

      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Update CMakeLists.txt version
        run: |
          sed -i "s/project(ProtonForge VERSION [0-9.]\+/project(ProtonForge VERSION ${{ steps.get_version.outputs.VERSION }}/" CMakeLists.txt
          cat CMakeLists.txt | grep "project(ProtonForge"

      - name: Build release version
        run: |
          mkdir -p cmake-build-release
          cd cmake-build-release
          cmake -DCMAKE_BUILD_TYPE=Release ..
          cmake --build . -j$(nproc)

      - name: Build .deb package
        run: |
          bash build-deb.sh

      - name: Verify .deb package was created
        run: |
          ls -lh protonforge_*.deb
          dpkg-deb --info protonforge_*.deb

      - name: Install Flatpak and dependencies
        run: |
          apt-get install -y flatpak flatpak-builder wget
          flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install -y flathub org.kde.Platform//6.8 org.kde.Sdk//6.8

      - name: Build Flatpak bundle
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}

          # Download and calculate SHA256 for the source archive
          wget "https://github.com/theinvisible/proton-forge/archive/v${VERSION}.tar.gz"
          SHA256=$(sha256sum "v${VERSION}.tar.gz" | awk '{print $1}')

          # Update SHA256 in manifest
          sed -i "s/sha256: REPLACE_WITH_ACTUAL_SHA256/sha256: ${SHA256}/" org.protonforge.ProtonForge.yml

          # Update version in manifest URL
          sed -i "s|url: https://github.com/theinvisible/proton-forge/archive/v[0-9.]\+\.tar\.gz|url: https://github.com/theinvisible/proton-forge/archive/v${VERSION}.tar.gz|" org.protonforge.ProtonForge.yml

          # Build Flatpak (disable rofiles-fuse for Docker compatibility)
          # Use --user flag and set environment variable to allow building without full sandboxing
          FLATPAK_BUILDER_ALLOW_HOST_BUILD=1 flatpak-builder --user --disable-rofiles-fuse --repo=flatpak-repo --force-clean flatpak-build org.protonforge.ProtonForge.yml

          # Create bundle
          flatpak build-bundle flatpak-repo protonforge.flatpak org.protonforge.ProtonForge

      - name: Verify Flatpak bundle was created
        run: |
          ls -lh protonforge.flatpak

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            protonforge_*.deb
            protonforge.flatpak
          generate_release_notes: true
          draft: false
          prerelease: false
          body: |
            ## ProtonForge v${{ steps.get_version.outputs.VERSION }}

            ### Installation

            **Flatpak (Recommended - Universal):**
            ```bash
            wget https://github.com/theinvisible/proton-forge/releases/download/v${{ steps.get_version.outputs.VERSION }}/protonforge.flatpak
            flatpak install protonforge.flatpak
            flatpak run org.protonforge.ProtonForge
            ```

            **Debian/Ubuntu:**
            ```bash
            wget https://github.com/theinvisible/proton-forge/releases/download/v${{ steps.get_version.outputs.VERSION }}/protonforge_${{ steps.get_version.outputs.VERSION }}_amd64.deb
            sudo dpkg -i protonforge_${{ steps.get_version.outputs.VERSION }}_amd64.deb
            sudo apt-get install -f
            ```

            **From Source:**
            ```bash
            git clone https://github.com/theinvisible/proton-forge.git
            cd proton-forge
            git checkout v${{ steps.get_version.outputs.VERSION }}
            mkdir build && cd build
            cmake -DCMAKE_BUILD_TYPE=Release ..
            cmake --build . -j$(nproc)
            ```

            ### What's Changed
            See the full changelog below.

            ---

            **Built on:** Ubuntu 25.10 (Oracular Oriole)
            **Qt Version:** 6.0+
            **GPU Focus:** NVIDIA (Proton management works on any GPU)

            *Compatible with Ubuntu 25.10, 24.04 LTS, and other Debian-based distributions with Qt6.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: protonforge-packages
          path: |
            protonforge_*.deb
            protonforge.flatpak
          retention-days: 30
